# CryptoBnB Smart Contract

A simple, gas-efficient smart contract for funding virtual cards with cryptocurrency payments, supporting both ERC20 tokens and native tokens (ETH).

## Overview

The `CryptoBnB` contract allows users to fund virtual cards using either ERC20 tokens or native cryptocurrency (ETH). The contract is designed for minimal gas usage and maximum simplicity, with all complex logic handled off-chain by the backend.

## Features

- **Dual Payment Support**: Users can fund virtual cards with ERC20 tokens or native ETH
- **Event-Driven**: Emits events that backends can listen to for card issuance
- **Admin Controls**: Owner can refund fundings and withdraw tokens/ETH
- **Gas Efficient**: Built with Solady for optimal gas usage
- **Secure**: Reentrancy protection and proper access controls

## Contract Interface

### Core Functions

```solidity
function fund(
    uint256 id,
    address tokenAddress,
    uint256 tokenAmount,
    string calldata currencyCode,
    uint256 fiatAmount
) external payable
```

**Parameters:**
- `id`: Unique card identifier (generated by backend)
- `tokenAddress`: ERC20 token address to pay with, or `address(0)` for native ETH
- `tokenAmount`: Amount of tokens/ETH to transfer
- `currencyCode`: Reference fiat currency (e.g., "SGD", "USD")
- `fiatAmount`: Reference fiat amount in cents

**Note:** When using native ETH (`tokenAddress = address(0)`), send `tokenAmount` as `msg.value`

### Admin Functions

```solidity
function refund(uint256 id) external onlyOwner
function withdrawTokens(address tokenAddress) external onlyOwner
function withdrawNative() external onlyOwner
```

**Admin Functions:**
- `refund(id)`: Refund a specific funding (returns tokens/ETH to user)
- `withdrawTokens(tokenAddress)`: Withdraw accumulated ERC20 tokens to owner
- `withdrawNative()`: Withdraw accumulated native ETH to owner

### Events

```solidity
event Funded(
    uint256 indexed id,
    uint256 indexed amount,
    string indexed currencyCode
);
```

Emitted when a card is successfully funded.

## Testing

Run the comprehensive test suite:

```bash
forge test
```

## Deployment

Deploy to any EVM-compatible network:

```bash
forge script script/DeployCryptoBnB.s.sol \
  --rpc-url $RPC_URL \
  --private-key $PRIVATE_KEY \
  --broadcast \
  --verify
```

## Backend Integration

1. **Listen for Events**: Monitor `Funded` events to know when cards are funded
2. **Issue Virtual Cards**: Backend creates actual virtual cards when events are received
3. **Handle Rates**: All fiat/crypto conversion logic happens off-chain
4. **Manage Cards**: Backend handles card lifecycle (creation, usage, expiration)
5. **Support Both Tokens**: Handle both ERC20 and native ETH payments seamlessly

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Smart Contract │    │   Backend       │
│                 │    │                  │    │                 │
│  - User selects │◄──►│  - fund()        │◄──►│  - Listen for   │
│    card & token │    │  - Events        │    │    events       │
│                 │    │  - Store funding │    │  - Issue cards  │
│  - Send ETH     │    │  - Handle both   │    │  - Process      │
│    or approve   │    │    tokens        │    │    payments     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Testing

Comprehensive test suite with **17 test cases** covering:

- ✅ ERC20 token funding and refunds
- ✅ Native ETH funding and refunds
- ✅ Admin token/ETH withdrawal functions
- ✅ Access control and security
- ✅ Event emission and validation
- ✅ Edge cases and error handling

Run tests: `forge test`

# Deployments
The address across all chains is `0xc6BB3C35f6a80338C49C3e4F2c083f21ac36d693`
- CELO Mainnet: https://celo.blockscout.com/address/0xc6bb3c35f6a80338c49c3e4f2c083f21ac36d693
- CELO Testnet: https://celo-sepolia.blockscout.com/address/0xc6BB3C35f6a80338C49C3e4F2c083f21ac36d693
- TAC Mainnet (TON): https://explorer.tac.build/address/0xc6bb3c35f6a80338c49c3e4f2c083f21ac36d693
- TAC Testnet (TON): https://spb.explorer.tac.build/address/0xc6bb3c35f6a80338c49c3e4f2c083f21ac36d693
- BNB Smart Chain: https://bscscan.com/address/0xc6bb3c35f6a80338c49c3e4f2c083f21ac36d693
- Moonbeam (Polkadot): https://moonbeam.moonscan.io/address/0xc6bb3c35f6a80338c49c3e4f2c083f21ac36d693
